pipeline {
    agent any
    
    environment {
        // Application Configuration
        APP_NAME = 'weather-api'
        IMAGE_NAME = 'weather-api'
        IMAGE_TAG = "${BUILD_NUMBER}"
        NAMESPACE = 'weather-api'
        
        // Docker Configuration
        DOCKER_IMAGE = "${IMAGE_NAME}:${IMAGE_TAG}"
        DOCKER_LATEST = "${IMAGE_NAME}:latest"
        
        // Kubernetes Configuration
        KUBECONFIG_PATH = "${HOME}/.kube/config"
        
        // Jenkins PATH Configuration (macOS)
        PATH = "/usr/local/bin:/opt/homebrew/bin:${env.PATH}"
        
        // Build Information
        BUILD_TIMESTAMP = sh(script: 'date +%Y%m%d-%H%M%S', returnStdout: true).trim()
    }
    
    stages {
        stage('ğŸ” Pre-flight Checks') {
            steps {
                script {
                    echo "ğŸš€ Starting Simple Weather API Deployment"
                    echo "ğŸ“¦ Build Number: ${BUILD_NUMBER}"
                    echo "ğŸ·ï¸  Image Tag: ${IMAGE_TAG}"
                    echo "â° Build Time: ${BUILD_TIMESTAMP}"
                    
                    // Check if Docker is available
                    sh '''
                        echo "ğŸ³ Checking Docker..."
                        docker --version || exit 1
                        docker info > /dev/null 2>&1 || (echo "âŒ Docker daemon not running" && exit 1)
                        echo "âœ… Docker is running"
                    '''
                    
                    // Check if kubectl is available
                    sh '''
                        echo "â˜¸ï¸  Checking Kubernetes..."
                        kubectl version --client || exit 1
                        kubectl cluster-info > /dev/null 2>&1 || (echo "âŒ Kubernetes cluster not accessible" && exit 1)
                        echo "âœ… Kubernetes cluster is accessible"
                    '''
                }
            }
        }
        
        stage('ğŸ“¥ Checkout Source Code') {
            steps {
                script {
                    echo "ğŸ“¥ Checking out source code..."
                    checkout scm
                    
                    // Display git information
                    sh '''
                        echo "ğŸ“‹ Git Information:"
                        echo "Branch: $(git branch --show-current || echo 'detached HEAD')"
                        echo "Commit: $(git rev-parse --short HEAD)"
                        echo "Author: $(git log -1 --pretty=format:'%an <%ae>')"
                        echo "Message: $(git log -1 --pretty=format:'%s')"
                    '''
                }
            }
        }
        
        stage('ğŸ“¦ Build Application') {
            steps {
                script {
                    echo "ğŸ“¦ Building Weather API application..."
                    sh '''
                        echo "ğŸ”¨ Building application with Maven..."
                        mvn clean package -DskipTests=true
                        
                        # Verify JAR was created
                        if [ -f target/*.jar ]; then
                            echo "âœ… JAR file created successfully:"
                            ls -la target/*.jar
                        else
                            echo "âŒ JAR file not found!" && exit 1
                        fi
                        
                        echo "ğŸ“‹ Build completed successfully!"
                    '''
                }
            }
        }
        
        stage('ğŸ³ Build Docker Image') {
            steps {
                script {
                    echo "ğŸ³ Building Docker image: ${DOCKER_IMAGE}"
                    sh '''
                        echo "ğŸ—ï¸  Building Docker image..."
                        docker build -t ${DOCKER_IMAGE} -t ${DOCKER_LATEST} .
                        
                        echo "ğŸ“‹ Image build completed:"
                        docker images | grep ${IMAGE_NAME}
                        
                        echo "ğŸ” Image size:"
                        docker images ${DOCKER_IMAGE} --format "table {{.Repository}}\\t{{.Tag}}\\t{{.Size}}"
                    '''
                }
            }
        }
        
        stage('ğŸ§¹ Cleanup Previous Deployment') {
            steps {
                script {
                    echo "ğŸ§¹ Cleaning up previous deployment..."
                    sh '''
                        echo "ğŸ—‘ï¸  Removing previous Kubernetes resources..."
                        kubectl delete -k k8s/ --ignore-not-found=true
                        
                        echo "â³ Waiting for cleanup to complete..."
                        sleep 10
                        
                        echo "âœ… Cleanup completed"
                    '''
                }
            }
        }
        
        stage('â˜¸ï¸  Deploy to Kubernetes') {
            steps {
                script {
                    echo "â˜¸ï¸  Deploying Weather API to Kubernetes..."
                    sh '''
                        echo "ğŸš€ Applying Kubernetes manifests..."
                        
                        # Apply all resources
                        kubectl apply -k k8s/
                        
                        echo "ğŸ“‹ Deployment status:"
                        kubectl get all -n ${NAMESPACE}
                        
                        echo "â³ Waiting for deployment to be ready..."
                        kubectl wait --for=condition=available --timeout=300s deployment/${APP_NAME} -n ${NAMESPACE}
                        
                        echo "âœ… Weather API deployed successfully!"
                    '''
                }
            }
        }
        
        stage('ğŸ” Verify Deployment') {
            steps {
                script {
                    echo "ğŸ” Verifying Weather API deployment..."
                    sh '''
                        echo "ğŸ¥ Checking pod status..."
                        kubectl get pods -n ${NAMESPACE} -o wide
                        
                        echo "ğŸ”— Checking service endpoints..."
                        kubectl get endpoints -n ${NAMESPACE}
                        
                        echo "ğŸ“Š Checking deployment status..."
                        kubectl rollout status deployment/${APP_NAME} -n ${NAMESPACE}
                        
                        echo "âœ… Deployment verification completed!"
                    '''
                }
            }
        }
        
        stage('ğŸ“Š Access Information') {
            steps {
                script {
                    echo "ğŸ“Š Weather API Access Information:"
                    sh '''
                        echo ""
                        echo "ğŸ‰ Weather API Deployment Summary:"
                        echo "=================================="
                        echo "ğŸŒ¤ï¸  Application: ${APP_NAME}"
                        echo "ğŸ“¦ Build: ${BUILD_NUMBER}"
                        echo "ğŸ·ï¸  Image: ${DOCKER_IMAGE}"
                        echo "ğŸ“ Namespace: ${NAMESPACE}"
                        echo "â° Deployed: ${BUILD_TIMESTAMP}"
                        echo ""
                        
                        echo "ğŸŒ API Endpoints:"
                        echo "â–¶ï¸  Main API: http://localhost:8080/weather-api"
                        echo "ğŸŒ¤ï¸  Weather: http://localhost:8080/weather-api/weather/{city}"
                        echo "ğŸ“Š Status: http://localhost:8080/weather-api/status"
                        echo "ğŸ¥ Health: http://localhost:8080/actuator/health"
                        echo ""
                        
                        echo "ğŸš€ To Access Your Weather API:"
                        echo "kubectl port-forward service/${APP_NAME}-service 8080:80 -n ${NAMESPACE}"
                        echo ""
                        
                        echo "ğŸ“‹ Current Resources:"
                        kubectl get all -n ${NAMESPACE}
                        echo ""
                        
                        echo "ğŸ“ Management Commands:"
                        echo "View Logs: kubectl logs -f deployment/${APP_NAME} -n ${NAMESPACE}"
                        echo "Scale App: kubectl scale deployment ${APP_NAME} --replicas=5 -n ${NAMESPACE}"
                        echo "Delete App: kubectl delete -k k8s/"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ§¹ Pipeline cleanup..."
                // Archive build artifacts
                archiveArtifacts artifacts: 'target/*.jar', allowEmptyArchive: true
                
                // Clean up old Docker images to save space
                sh '''
                    echo "ğŸ—‘ï¸  Cleaning up old Docker images..."
                    docker image prune -f || true
                '''
            }
        }
        
        success {
            script {
                echo """
                ğŸ‰ SUCCESS! Weather API deployed successfully!
                
                ğŸŒ¤ï¸  Your Weather API is now running!
                
                ğŸ“± Quick Access:
                1ï¸âƒ£  kubectl port-forward service/${APP_NAME}-service 8080:80 -n ${NAMESPACE}
                2ï¸âƒ£  Open: http://localhost:8080/weather-api
                
                ğŸŒ Available Endpoints:
                â€¢ Main API: /weather-api
                â€¢ Get Weather: /weather-api/weather/{city}
                â€¢ Status Check: /weather-api/status
                â€¢ Health Check: /actuator/health
                
                ğŸ“Š Monitor your deployment:
                kubectl get all -n ${NAMESPACE}
                kubectl logs -f deployment/${APP_NAME} -n ${NAMESPACE}
                """
            }
        }
        
        failure {
            script {
                echo """
                âŒ DEPLOYMENT FAILED!
                
                ğŸ” Troubleshooting steps:
                1. Check build logs above
                2. Verify Docker daemon is running
                3. Verify Kubernetes cluster access
                4. Check resource availability in cluster
                
                ğŸ“‹ Debug commands:
                kubectl get events -n ${NAMESPACE} --sort-by='.lastTimestamp'
                kubectl describe pods -n ${NAMESPACE}
                docker logs \$(docker ps -lq)
                """
                
                // Cleanup on failure
                sh '''
                    echo "ğŸ§¹ Cleaning up failed deployment..."
                    kubectl delete -k k8s/ --ignore-not-found=true || true
                '''
            }
        }
    }
} 